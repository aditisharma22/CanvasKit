<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Line Break Opportunities Viewer</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
      color: #333;
      line-height: 1.5;
    }
    
    h1, h2, h3 {
      color: #333;
    }
    
    pre {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      overflow: auto;
      margin-bottom: 20px;
      max-height: 400px;
      font-family: Consolas, Monaco, 'Andale Mono', monospace;
    }
    
    .json-key {
      color: #0066cc;
    }
    
    .json-string {
      color: #009900;
    }
    
    .json-number {
      color: #ff6600;
    }
    
    .json-boolean {
      color: #cc00cc;
    }
    
    .json-null {
      color: #999;
    }
    
    .control-panel {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    input, select, textarea, button {
      font-family: inherit;
      font-size: 16px;
      padding: 8px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    
    textarea {
      width: 100%;
      height: 100px;
      resize: vertical;
    }
    
    button {
      background-color: #0078d7;
      color: white;
      border: none;
      padding: 10px 15px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    button:hover {
      background-color: #0062b1;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    
    .word {
      display: inline-block;
      border: 1px solid #ccc;
      padding: 5px 10px;
      margin: 5px;
      border-radius: 3px;
      position: relative;
    }
    
    .word.allow {
      border-color: #009900;
      background-color: rgba(0, 153, 0, 0.1);
    }
    
    .word.avoid {
      border-color: #cc0000;
      background-color: rgba(204, 0, 0, 0.1);
    }
    
    .word-info {
      position: absolute;
      background: white;
      border: 1px solid #ccc;
      padding: 5px;
      border-radius: 3px;
      font-size: 12px;
      bottom: 100%;
      left: 0;
      display: none;
      min-width: 150px;
      z-index: 100;
      white-space: nowrap;
    }
    
    .word:hover .word-info {
      display: block;
    }
    
    .visualization {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
  <h1>Line Break Opportunities Viewer</h1>
  
  <div class="control-panel">
    <div class="form-group">
      <label for="locale-select">Select Locale:</label>
      <select id="locale-select">
        <option value="en">English (en)</option>
        <option value="fr">French (fr)</option>
        <option value="de">German (de)</option>
        <option value="es">Spanish (es)</option>
        <option value="ja">Japanese (ja)</option>
        <option value="zh">Chinese (zh)</option>
        <option value="ko">Korean (ko)</option>
        <option value="th">Thai (th)</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="test-case-select">Select Pre-defined Test Case:</label>
      <select id="test-case-select">
        <option value="">-- Choose from test cases --</option>
      </select>
    </div>
    
    <div class="form-group">
      <label for="input-text">Or Enter Custom Text:</label>
      <textarea id="input-text" placeholder="Type or paste text here..."></textarea>
    </div>
    
    <button id="analyze-btn">Analyze Line Break Opportunities</button>
  </div>
  
  <div id="results-container" style="display: none;">
    <h2>Analysis Results</h2>
    <div class="form-group">
      <label for="width-input">Line Width (px):</label>
      <input type="number" id="width-input" value="300" min="50" max="800" step="10">
      <button id="update-width-btn">Update Width</button>
    </div>
    
    <h3>Text Visualization with Line Break Opportunities</h3>
    <div id="visualization" class="visualization"></div>
    
    <h3>JSON Output</h3>
    <pre id="json-output"></pre>
    
    <h3>Line Break Analysis</h3>
    <div class="visualization">
      <div id="best-fit">
        <h4>Best Fit Layout</h4>
        <div id="best-fit-layout"></div>
      </div>
      <div id="uniform">
        <h4>Most Uniform Layout</h4>
        <div id="uniform-layout"></div>
      </div>
    </div>
  </div>
  
  <script type="module">
    // Add error handling for imports
    let testCases, processTextForLineBreaking, enhanceWordMetricsWithRules, createLocalizedLineBreakOptimizer, computeBreaks;
    
    try {
      const testDataModule = await import('./src/localization/testData.js');
      testCases = testDataModule.testCases;
      
      const segmenterModule = await import('./src/localization/segmenter.js');
      processTextForLineBreaking = segmenterModule.processTextForLineBreaking;
      
      const lineBreakingModule = await import('./src/localized_line_breaking.js');
      createLocalizedLineBreakOptimizer = lineBreakingModule.createLocalizedLineBreakOptimizer;
      enhanceWordMetricsWithRules = lineBreakingModule.enhanceWordMetricsWithLocalization;
      
      const optimizerModule = await import('./src/optimize_linebreaks.js');
      computeBreaks = optimizerModule.computeBreaks;
      
      console.log('All modules imported successfully');
    } catch (error) {
      console.error('Error importing modules:', error);
      document.body.innerHTML = `
        <div style="color: red; padding: 20px; border: 1px solid red; margin: 20px; font-family: sans-serif;">
          <h2>Module Import Error</h2>
          <p>${error.message}</p>
          <p>Please check the browser console for more details.</p>
        </div>
      `;
    }
    
    // DOM elements
    const localeSelect = document.getElementById('locale-select');
    const testCaseSelect = document.getElementById('test-case-select');
    const inputText = document.getElementById('input-text');
    const analyzeBtn = document.getElementById('analyze-btn');
    const resultsContainer = document.getElementById('results-container');
    const jsonOutput = document.getElementById('json-output');
    const visualization = document.getElementById('visualization');
    const widthInput = document.getElementById('width-input');
    const updateWidthBtn = document.getElementById('update-width-btn');
    const bestFitLayout = document.getElementById('best-fit-layout');
    const uniformLayout = document.getElementById('uniform-layout');
    
    // Create localized optimizer
    const localizedComputeBreaks = createLocalizedLineBreakOptimizer(computeBreaks);
    
    // Current analysis data
    let currentProcessedText = null;
    let currentWordMetrics = null;
    
    // Populate test case dropdown
    function populateTestCases(locale) {
      // Clear existing options except the first one
      while (testCaseSelect.options.length > 1) {
        testCaseSelect.remove(1);
      }
      
      // Filter test cases by locale
      const filteredCases = testCases.filter(test => test.locale === locale);
      
      // Add test cases to dropdown
      filteredCases.forEach((test, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = test.text.length > 50 
          ? test.text.substring(0, 50) + '...'
          : test.text;
        testCaseSelect.appendChild(option);
      });
    }
    
    // Format JSON with syntax highlighting
    function syntaxHighlight(json) {
      if (typeof json !== 'string') {
        json = JSON.stringify(json, null, 2);
      }
      json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, 
        function (match) {
          let cls = 'json-number';
          if (/^"/.test(match)) {
            if (/:$/.test(match)) {
              cls = 'json-key';
            } else {
              cls = 'json-string';
            }
          } else if (/true|false/.test(match)) {
            cls = 'json-boolean';
          } else if (/null/.test(match)) {
            cls = 'json-null';
          }
          return '<span class="' + cls + '">' + match + '</span>';
        }
      );
    }
    
    // Visualize text with line break opportunities
    function visualizeText(wordMetrics) {
      visualization.innerHTML = '';
      
      // Check if wordMetrics is in expected format
      if (!wordMetrics || !Array.isArray(wordMetrics)) {
        visualization.innerHTML = '<div style="color: red;">Invalid word metrics data</div>';
        return;
      }
      
      wordMetrics.forEach((word, index) => {
        if (!word) return;
        
        const wordEl = document.createElement('div');
        wordEl.className = `word ${word.lineBreaking || 'allow'}`;
        wordEl.textContent = word.text || `Word ${index}`;
        
        const info = document.createElement('div');
        info.className = 'word-info';
        
        // Build properties list
        const properties = [];
        properties.push(`<strong>Index:</strong> ${index}`);
        properties.push(`<strong>Text:</strong> "${word.text || ''}"`);
        properties.push(`<strong>Line Breaking:</strong> ${word.lineBreaking || 'allow'}`);
        
        if (word.width !== undefined) {
          properties.push(`<strong>Width:</strong> ${Math.round(word.width)}px`);
        }
        
        if (word.separator) {
          properties.push(`<strong>Separator:</strong> "${word.separator}"`);
        }
        
        // Add any other properties the word might have
        Object.keys(word).forEach(key => {
          if (!['text', 'width', 'lineBreaking', 'separator'].includes(key)) {
            const value = word[key];
            if (typeof value !== 'object' || value === null) {
              properties.push(`<strong>${key}:</strong> ${value}`);
            }
          }
        });
        
        info.innerHTML = properties.join('<br>');
        wordEl.appendChild(info);
        visualization.appendChild(wordEl);
      });
    }
    
    // Visualize line breaks
    function visualizeLineBreaks(container, words, breaks) {
      container.innerHTML = '';
      
      let lines = [];
      let currentLine = [];
      
      words.forEach((word, index) => {
        currentLine.push(word);
        if (breaks.includes(index)) {
          lines.push([...currentLine]);
          currentLine = [];
        }
      });
      
      // Add last line if not empty
      if (currentLine.length > 0) {
        lines.push(currentLine);
      }
      
      // Create line elements
      lines.forEach((line, lineIndex) => {
        const lineEl = document.createElement('div');
        lineEl.className = 'line';
        lineEl.style.marginBottom = '10px';
        lineEl.textContent = line.join(' ');
        container.appendChild(lineEl);
      });
    }
    
    // Analyze text and show results
    async function analyzeText() {
      // Add an error display area if it doesn't exist
      if (!document.getElementById('error-display')) {
        const errorDisplay = document.createElement('div');
        errorDisplay.id = 'error-display';
        errorDisplay.style.color = '#cc0000';
        errorDisplay.style.backgroundColor = '#ffeeee';
        errorDisplay.style.padding = '10px';
        errorDisplay.style.margin = '10px 0';
        errorDisplay.style.borderRadius = '4px';
        errorDisplay.style.border = '1px solid #cc0000';
        errorDisplay.style.display = 'none';
        document.querySelector('.control-panel').appendChild(errorDisplay);
      }
      
      const errorDisplay = document.getElementById('error-display');
      errorDisplay.style.display = 'none';
      errorDisplay.innerHTML = '';
      
      const text = inputText.value.trim();
      const locale = localeSelect.value;
      
      if (!text) {
        alert('Please enter some text or select a test case.');
        return;
      }
      
      try {
        // Debug info
        console.log('Processing text:', text);
        console.log('Locale:', locale);
        
        // Process text for line breaks
        console.log('Calling processTextForLineBreaking...');
        currentProcessedText = await processTextForLineBreaking(text, locale);
        console.log('Processed text result:', currentProcessedText);
        
        // Check if processedText contains expected properties
        if (!currentProcessedText || !currentProcessedText.words || !currentProcessedText.wordWidths) {
          throw new Error('Invalid result from text processing. Missing words or wordWidths.');
        }
        
        // Enhance with localization rules
        console.log('Calling enhanceWordMetricsWithLocalization...');
        currentWordMetrics = await enhanceWordMetricsWithRules(
          currentProcessedText.words.map((word, i) => ({
            text: word,
            width: currentProcessedText.wordWidths[i]
          })),
          locale
        );
        console.log('Enhanced word metrics:', currentWordMetrics);
        
        // Add width to current word metrics for visualization
        currentWordMetrics.forEach((metric, i) => {
          metric.width = currentProcessedText.wordWidths[i];
          metric.text = currentProcessedText.words[i];
        });
        
        // Compute line breaks
        const width = parseInt(widthInput.value);
        console.log('Calling localizedComputeBreaks with width:', width);
        const result = await localizedComputeBreaks({
          words: currentProcessedText.words,
          wordWidths: currentProcessedText.wordWidths,
          spaceWidth: currentProcessedText.spaceWidth,
          targetWidth: width,
          candidateCount: 5,
          balanceFactor: 0.5,
          minFillRatio: 0.5,
          locale: locale
        });
        console.log('Line break results:', result);
        
        // Show results
        resultsContainer.style.display = 'block';
        
        // Show JSON output
        jsonOutput.innerHTML = syntaxHighlight(currentWordMetrics);
        
        // Visualize text with line break opportunities
        visualizeText(currentWordMetrics);
        
        // Visualize line break layouts
        visualizeLineBreaks(bestFitLayout, currentProcessedText.words, result.bestFitBreaks);
        visualizeLineBreaks(uniformLayout, currentProcessedText.words, result.mostUniformBreaks);
        
      } catch (error) {
        console.error('Error analyzing text:', error);
        errorDisplay.innerHTML = `<strong>Error analyzing text:</strong><br>${error.message}<br><br><strong>Debug info:</strong><br>If possible, please check the browser console for more details.`;
        errorDisplay.style.display = 'block';
        
        // Log detailed error info
        console.error('Full error details:', error);
        if (error.stack) console.error('Stack trace:', error.stack);
      }
    }
    
    // Event: Locale selection change
    localeSelect.addEventListener('change', () => {
      populateTestCases(localeSelect.value);
    });
    
    // Event: Test case selection
    testCaseSelect.addEventListener('change', () => {
      const selectedIndex = testCaseSelect.value;
      if (selectedIndex !== '') {
        const filteredCases = testCases.filter(test => test.locale === localeSelect.value);
        const selectedTest = filteredCases[parseInt(selectedIndex)];
        inputText.value = selectedTest.text;
      }
    });
    
    // Event: Analyze button click
    analyzeBtn.addEventListener('click', analyzeText);
    
    // Event: Update width button click
    updateWidthBtn.addEventListener('click', async () => {
      if (!currentProcessedText) return;
      
      const width = parseInt(widthInput.value);
      
      try {
        // Recompute line breaks
        const result = await localizedComputeBreaks({
          words: currentProcessedText.words,
          wordWidths: currentProcessedText.wordWidths,
          spaceWidth: currentProcessedText.spaceWidth,
          targetWidth: width,
          candidateCount: 5,
          balanceFactor: 0.5,
          minFillRatio: 0.5,
          locale: localeSelect.value
        });
        
        // Update line break layouts
        visualizeLineBreaks(bestFitLayout, currentProcessedText.words, result.bestFitBreaks);
        visualizeLineBreaks(uniformLayout, currentProcessedText.words, result.mostUniformBreaks);
      } catch (error) {
        console.error('Error updating width:', error);
        alert('Error updating width: ' + error.message);
      }
    });
    
    // Initialize page
    populateTestCases(localeSelect.value);
    
    // Check for French example from your selection
    const frenchSample = "Apple Music Super Bowl : la performance.";
    if (localeSelect.querySelector('option[value="fr"]')) {
      localeSelect.value = 'fr';
      populateTestCases('fr');
      
      // Find the test case or set custom text
      const testIndex = testCases
        .filter(test => test.locale === 'fr')
        .findIndex(test => test.text.includes("Apple Music Super Bowl"));
      
      if (testIndex >= 0) {
        testCaseSelect.value = testIndex;
        // Set the input text from the test case
        inputText.value = testCases.filter(test => test.locale === 'fr')[testIndex].text;
      } else {
        inputText.value = frenchSample;
      }
      
      // Analyze automatically
      console.log("Analyzing French example automatically");
      setTimeout(() => {
        try {
          analyzeBtn.click();
        } catch (e) {
          console.error("Error auto-analyzing:", e);
        }
      }, 500);
    }
  </script>
</body>
</html>
